{"version":3,"file":"publisher.js","sourceRoot":"","sources":["../src/publisher.ts"],"names":[],"mappings":"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","sourcesContent":["import { Arch, log } from \"builder-util\"\nimport { CancellationToken, ProgressCallbackTransform } from \"builder-util-runtime\"\nimport { PADDING } from \"builder-util/out/log\"\nimport chalk from \"chalk\"\nimport { createReadStream, stat, Stats } from \"fs-extra-p\"\nimport { ClientRequest } from \"http\"\nimport { basename } from \"path\"\nimport { MultiProgress } from \"./multiProgress\"\nimport { ProgressBar } from \"./progress\"\n\nexport type PublishPolicy = \"onTag\" | \"onTagOrDraft\" | \"always\" | \"never\"\n\nexport { ProgressCallback } from \"./progress\"\n\nexport interface PublishOptions {\n  publish?: PublishPolicy | null\n}\n\nexport interface PublishContext {\n  readonly cancellationToken: CancellationToken\n  readonly progress: MultiProgress | null\n}\n\nconst progressBarOptions = {\n  incomplete: \" \",\n  width: 20,\n}\n\nexport interface UploadTask {\n  file: string\n  fileContent?: Buffer | null\n\n  arch: Arch | null\n  safeArtifactName?: string | null\n}\n\nexport abstract class Publisher {\n  protected constructor(protected readonly context: PublishContext) {\n  }\n\n  abstract get providerName(): string\n\n  abstract upload(task: UploadTask): Promise<any>\n\n  protected createProgressBar(fileName: string, size: number): ProgressBar | null {\n    log.info({file: fileName, provider: this.providerName}, \"uploading\")\n    if (this.context.progress == null || size < (512 * 1024)) {\n      return null\n    }\n    return this.context.progress.createBar(`${\" \".repeat(PADDING + 2)}[:bar] :percent :etas | ${chalk.green(fileName)} to ${this.providerName}`, {total: size, ...progressBarOptions})\n  }\n\n  protected createReadStreamAndProgressBar(file: string, fileStat: Stats, progressBar: ProgressBar | null, reject: (error: Error) => void): NodeJS.ReadableStream {\n    const fileInputStream = createReadStream(file)\n    fileInputStream.on(\"error\", reject)\n\n    if (progressBar == null) {\n      return fileInputStream\n    }\n    else {\n      const progressStream = new ProgressCallbackTransform(fileStat.size, this.context.cancellationToken, it => progressBar.tick(it.delta))\n      progressStream.on(\"error\", reject)\n      return fileInputStream.pipe(progressStream)\n    }\n  }\n\n  abstract toString(): string\n}\n\nexport abstract class HttpPublisher extends Publisher {\n  constructor(protected readonly context: PublishContext, private readonly useSafeArtifactName = false) {\n    super(context)\n  }\n\n  async upload(task: UploadTask): Promise<any> {\n    const fileName = (this.useSafeArtifactName ? task.safeArtifactName : null) || basename(task.file)\n\n    if (task.fileContent != null) {\n      await this.doUpload(fileName, task.arch || Arch.x64, task.fileContent.length, it => it.end(task.fileContent))\n      return\n    }\n\n    const fileStat = await stat(task.file)\n\n    const progressBar = this.createProgressBar(fileName, fileStat.size)\n    await this.doUpload(fileName, task.arch || Arch.x64, fileStat.size, (request, reject) => {\n      if (progressBar != null) {\n        // reset (because can be called several times (several attempts)\n        progressBar.update(0)\n      }\n      return this.createReadStreamAndProgressBar(task.file, fileStat, progressBar, reject).pipe(request)\n    }, task.file)\n  }\n\n  protected abstract doUpload(fileName: string, arch: Arch, dataLength: number, requestProcessor: (request: ClientRequest, reject: (error: Error) => void) => void, file?: string): Promise<any>\n}\n\nexport function getCiTag() {\n  const tag = process.env.TRAVIS_TAG || process.env.APPVEYOR_REPO_TAG_NAME || process.env.CIRCLE_TAG || process.env.BITRISE_GIT_TAG || process.env.CI_BUILD_TAG\n  return tag != null && tag.length > 0 ? tag : null\n}"]}
