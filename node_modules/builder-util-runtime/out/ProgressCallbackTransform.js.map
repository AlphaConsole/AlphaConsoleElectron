{"version":3,"file":"ProgressCallbackTransform.js","sourceRoot":"","sources":["../src/ProgressCallbackTransform.ts"],"names":[],"mappings":";;;;;;;;;AAAA,AAAO,AAAE,AAAS,AAAE,AAAM,AAAQ,AAWlC,AAAM;;;;MAAiC,AAAQ,AAAS;AAOtD,gBAA6B,AAAa,OAAmB,AAAoC,mBAAmB,AAAuC;AACzJ,AAAK,AAAE;AADoB,aAAK,QAAL,AAAK,AAAQ;AAAmB,aAAiB,oBAAjB,AAAiB,AAAmB;AAAmB,aAAU,aAAV,AAAU,AAA6B;AANnJ,aAAK,QAAG,AAAI,KAAC,AAAG,AAAE;AAClB,aAAW,cAAG,AAAC;AACf,aAAK,QAAG,AAAC;AAET,aAAU,aAAG,AAAI,KAAC,AAAK,QAAG,AAAI,AAItC;AAAC;AAED,AAAU,eAAC,AAAU,OAAE,AAAgB,UAAE,AAAa;AACpD,AAAE,AAAC,YAAC,AAAI,KAAC,AAAiB,kBAAC,AAAS,AAAC,WAAC,AAAC;AACrC,AAAQ,qBAAC,IAAI,AAAK,MAAC,AAAW,AAAC,cAAE,AAAI,AAAC;AACtC,AAAM,AACR;AAAC;AAED,AAAI,aAAC,AAAW,eAAI,AAAK,MAAC,AAAM;AAChC,AAAI,aAAC,AAAK,SAAI,AAAK,MAAC,AAAM;AAE1B,cAAM,AAAG,MAAG,AAAI,KAAC,AAAG,AAAE;AACtB,AAAE,AAAC,YAAC,AAAG,OAAI,AAAI,KAAC,AAAU,cAAI,AAAI,KAAC,AAAW,gBAAK,AAAI,KAAC,AAAK,MAAC,AAA+B,AAAC,iCAAC,AAAC;AAC9F,AAAI,qBAAC,AAAU,aAAG,AAAG,MAAG,AAAI;AAE5B,AAAI,qBAAC,AAAU;AACb,AAAK,2BAAE,AAAI,KAAC,AAAK;AACjB,AAAK,2BAAE,AAAI,KAAC,AAAK;AACjB,AAAW,iCAAE,AAAI,KAAC,AAAW;AAC7B,AAAO,6BAAG,AAAI,KAAC,AAAW,cAAG,AAAI,KAAC,AAAK,AAAC,KAA/B,GAAkC,AAAG;AAC9C,AAAc,oCAAE,AAAI,KAAC,AAAK,MAAC,AAAI,KAAC,AAAW,AAAG,eAAC,CAAC,AAAG,MAAG,AAAI,KAAC,AAAK,AAAC,SAAG,AAAI,AAAC,AAAC,AAC3E,AAAC;AANc;AAOhB,AAAI,qBAAC,AAAK,QAAG,AAAC,AAChB;AAAC;AAED,AAAQ,iBAAC,AAAI,MAAE,AAAK,AAAC,AACvB;AAAC;AAED,AAAM,WAAC,AAAa;AAClB,AAAE,AAAC,YAAC,AAAI,KAAC,AAAiB,kBAAC,AAAS,AAAC,WAAC,AAAC;AACrC,AAAQ,qBAAC,IAAI,AAAK,MAAC,AAAW,AAAC,AAAC;AAChC,AAAM,AACR;AAAC;AAED,AAAI,aAAC,AAAU;AACb,AAAK,mBAAE,AAAI,KAAC,AAAK;AACjB,AAAK,mBAAE,AAAI,KAAC,AAAK;AACjB,AAAW,yBAAE,AAAI,KAAC,AAAK;AACvB,AAAO,qBAAE,AAAG;AACZ,AAAc,4BAAE,AAAI,KAAC,AAAK,MAAC,AAAI,KAAC,AAAW,AAAG,eAAC,CAAC,AAAI,KAAC,AAAG,AAAE,QAAG,AAAI,KAAC,AAAK,AAAC,SAAG,AAAI,AAAC,AAAC,AAClF,AAAC;AANc;AAOhB,AAAI,aAAC,AAAK,QAAG,AAAC;AAEd,AAAQ,iBAAC,AAAI,AAAC,AAChB;AAAC,AACF","sourcesContent":["import { Transform } from \"stream\"\nimport { CancellationToken } from \"./CancellationToken\"\n\nexport interface ProgressInfo {\n  total: number\n  delta: number\n  transferred: number\n  percent: number\n  bytesPerSecond: number\n}\n\nexport class ProgressCallbackTransform extends Transform {\n  private start = Date.now()\n  private transferred = 0\n  private delta = 0\n\n  private nextUpdate = this.start + 1000\n\n  constructor(private readonly total: number, private readonly cancellationToken: CancellationToken, private readonly onProgress: (info: ProgressInfo) => any) {\n    super()\n  }\n\n  _transform(chunk: any, encoding: string, callback: any) {\n    if (this.cancellationToken.cancelled) {\n      callback(new Error(\"Cancelled\"), null)\n      return\n    }\n\n    this.transferred += chunk.length\n    this.delta += chunk.length\n\n    const now = Date.now()\n    if (now >= this.nextUpdate && this.transferred !== this.total /* will be emitted on _flush */) {\n      this.nextUpdate = now + 1000\n\n      this.onProgress({\n        total: this.total,\n        delta: this.delta,\n        transferred: this.transferred,\n        percent: (this.transferred / this.total) * 100,\n        bytesPerSecond: Math.round(this.transferred / ((now - this.start) / 1000))\n      })\n      this.delta = 0\n    }\n\n    callback(null, chunk)\n  }\n\n  _flush(callback: any): void {\n    if (this.cancellationToken.cancelled) {\n      callback(new Error(\"Cancelled\"))\n      return\n    }\n\n    this.onProgress({\n      total: this.total,\n      delta: this.delta,\n      transferred: this.total,\n      percent: 100,\n      bytesPerSecond: Math.round(this.transferred / ((Date.now() - this.start) / 1000))\n    })\n    this.delta = 0\n\n    callback(null)\n  }\n}\n"]}
