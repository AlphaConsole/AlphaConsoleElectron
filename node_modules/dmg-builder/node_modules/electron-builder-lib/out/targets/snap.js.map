{"version":3,"file":"snap.js","sourceRoot":"","sources":["../../src/targets/snap.ts"],"names":[],"mappings":"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","sourcesContent":["import { Arch, replaceDefault as _replaceDefault, serializeToYaml, executeAppBuilder, toLinuxArchString } from \"builder-util\"\nimport { chmod, outputFile, writeFile } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { SnapOptions } from \"..\"\nimport { asArray } from \"builder-util-runtime\"\nimport { Target } from \"../core\"\nimport { LinuxPackager, toAppImageOrSnapArch } from \"../linuxPackager\"\nimport { PlugDescriptor } from \"../options/SnapOptions\"\nimport { LinuxTargetHelper } from \"./LinuxTargetHelper\"\nimport { createStageDirPath } from \"./targetUtil\"\n\n// libxss1, libasound2, gconf2 - was \"error while loading shared libraries: libXss.so.1\" on Xubuntu 16.04\nconst defaultStagePackages = [\"libasound2\", \"libgconf2-4\", \"libnotify4\", \"libnspr4\", \"libnss3\", \"libpcre3\", \"libpulse0\", \"libxss1\", \"libxtst6\"]\nconst defaultPlugs = [\"desktop\", \"desktop-legacy\", \"home\", \"x11\", \"unity7\", \"browser-support\", \"network\", \"gsettings\", \"pulseaudio\", \"opengl\"]\n\nexport default class SnapTarget extends Target {\n  readonly options: SnapOptions = {...this.packager.platformSpecificBuildOptions, ...(this.packager.config as any)[this.name]}\n\n  private isUseTemplateApp = false\n\n  constructor(name: string, private readonly packager: LinuxPackager, private readonly helper: LinuxTargetHelper, readonly outDir: string) {\n    super(name)\n  }\n\n  private replaceDefault(inList: Array<string> | null | undefined, defaultList: Array<string>) {\n    const result = _replaceDefault(inList, defaultList)\n    if (result !== defaultList) {\n      this.isUseTemplateApp = false\n    }\n    return result\n  }\n\n  private createDescriptor(snapName: string, arch: Arch): any {\n    const appInfo = this.packager.appInfo\n    const options = this.options\n    const linuxArchName = toAppImageOrSnapArch(arch)\n\n    const plugs = normalizePlugConfiguration(options.plugs)\n    const plugNames = this.replaceDefault(plugs == null ? null : Object.getOwnPropertyNames(plugs), defaultPlugs)\n\n    const buildPackages = asArray(options.buildPackages)\n    this.isUseTemplateApp = this.options.useTemplateApp !== false && arch === Arch.x64 && buildPackages.length === 0\n\n    const appDescriptor: any = {\n      command: `command.sh`,\n      environment: {\n        TMPDIR: \"$XDG_RUNTIME_DIR\",\n        PATH: \"$SNAP/usr/sbin:$SNAP/usr/bin:$SNAP/sbin:$SNAP/bin:$PATH\",\n        LD_LIBRARY_PATH: [\n          \"$SNAP_LIBRARY_PATH\",\n          \"$SNAP/usr/lib/\" + linuxArchName + \"-linux-gnu:$SNAP/usr/lib/\" + linuxArchName + \"-linux-gnu/pulseaudio\",\n          \"$SNAP/usr/lib/\" + linuxArchName + \"-linux-gnu/mesa-egl\",\n          \"$SNAP/lib:$SNAP/usr/lib:$SNAP/lib/\" + linuxArchName + \"-linux-gnu:$SNAP/usr/lib/\" + linuxArchName + \"-linux-gnu\",\n          \"$LD_LIBRARY_PATH:$SNAP/lib:$SNAP/usr/lib\",\n          \"$SNAP/lib/\" + linuxArchName + \"-linux-gnu:$SNAP/usr/lib/\" + linuxArchName + \"-linux-gnu\"\n        ].join(\":\"),\n        ...options.environment,\n      },\n      plugs: plugNames,\n    }\n    const snap: any = {\n      name: snapName,\n      version: appInfo.version,\n      summary: options.summary || appInfo.productName,\n      description: this.helper.getDescription(options),\n      confinement: options.confinement || \"strict\",\n      grade: options.grade || \"stable\",\n      architectures: [toLinuxArchString(arch)],\n      apps: {\n        [snapName]: appDescriptor\n      },\n      parts: {\n        app: {\n          plugin: \"nil\",\n          \"stage-packages\": this.replaceDefault(options.stagePackages, defaultStagePackages),\n          after: this.replaceDefault(options.after, [this.packager.isElectron2 ? \"desktop-gtk3\" : \"desktop-gtk2\"]),\n        }\n      },\n    }\n\n    if (!this.isUseTemplateApp) {\n      appDescriptor.adapter = \"none\"\n    }\n\n    if (buildPackages.length > 0) {\n      snap.parts.app[\"build-packages\"] = buildPackages\n    }\n\n    if (plugs != null) {\n      for (const plugName of plugNames) {\n        const plugOptions = plugs[plugName]\n        if (plugOptions == null) {\n          continue\n        }\n\n        if (snap.plugs == null) {\n          snap.plugs = {}\n        }\n        snap.plugs[plugName] = plugOptions\n      }\n    }\n\n    if (options.assumes != null) {\n      snap.assumes = asArray(options.assumes)\n    }\n    return snap\n  }\n\n  async build(appOutDir: string, arch: Arch): Promise<any> {\n    const packager = this.packager\n    const options = this.options\n    const snapName = packager.executableName.toLowerCase()\n    const snapFileName = `${snapName}_${packager.appInfo.version}_${toLinuxArchString(arch)}.snap`\n    const artifactPath = path.join(this.outDir, snapFileName)\n    this.logBuilding(\"snap\", artifactPath, arch)\n\n    const snap: any = this.createDescriptor(snapName, arch)\n    if (this.isUseTemplateApp) {\n      delete snap.parts\n    }\n\n    const stageDir = await createStageDirPath(this, packager, arch)\n    // snapcraft.yaml inside a snap directory\n    const snapMetaDir = path.join(stageDir, this.isUseTemplateApp ? \"meta\" : \"snap\")\n\n    const args = [\n      \"snap\",\n      \"--app\", appOutDir,\n      \"--stage\", stageDir,\n      \"--arch\", toLinuxArchString(arch),\n      \"--output\", artifactPath,\n      \"--docker-image\", this.packager.isElectron2 ? \"electronuserland/snapcraft-electron:2\" : \"electronuserland/builder:latest\",\n    ]\n\n    await this.helper.icons\n    if (this.helper.maxIconPath != null) {\n      if (!this.isUseTemplateApp) {\n        snap.icon = \"snap/gui/icon.png\"\n      }\n      args.push(\"--icon\", this.helper.maxIconPath)\n    }\n\n    const desktopFile = path.join(snapMetaDir, \"gui\", `${snap.name}.desktop`)\n    await this.helper.writeDesktopEntry(this.options, packager.executableName, desktopFile, {\n      // tslint:disable:no-invalid-template-strings\n      Icon: \"${SNAP}/meta/gui/icon.png\"\n    })\n\n    if (packager.packagerOptions.effectiveOptionComputed != null && await packager.packagerOptions.effectiveOptionComputed({snap, desktopFile})) {\n      return\n    }\n\n    await outputFile(path.join(snapMetaDir, this.isUseTemplateApp ? \"snap.yaml\" : \"snapcraft.yaml\"), serializeToYaml(snap))\n\n    const commandWrapperFile = path.join(stageDir, \"command.sh\")\n    // noinspection SpellCheckingInspection\n    await writeFile(commandWrapperFile, `#!/bin/bash\\nexec $SNAP/bin/desktop-launch \"$SNAP/${this.isUseTemplateApp ? \"\" : \"app/\"}${this.packager.executableName}\"`)\n    await chmod(commandWrapperFile, 0o755)\n\n    const hooksDir = await packager.getResource(options.hooks, \"snap-hooks\")\n    if (hooksDir != null) {\n      args.push(\"--hooks\", hooksDir)\n    }\n\n    if (this.isUseTemplateApp) {\n      args.push(\"--template-url\", this.packager.isElectron2 ? \"electron2\" : \"electron1\")\n    }\n    await executeAppBuilder(args)\n    packager.dispatchArtifactCreated(artifactPath, this, arch)\n  }\n}\n\nfunction normalizePlugConfiguration(raw: Array<string | PlugDescriptor> | PlugDescriptor | null | undefined): { [key: string]: PlugDescriptor | null } | null {\n  if (raw == null) {\n    return null\n  }\n\n  const result: any = {}\n  for (const item of (Array.isArray(raw) ? raw : [raw])) {\n    if (typeof item === \"string\") {\n      result[item] = null\n    }\n    else {\n      Object.assign(result, item)\n    }\n  }\n  return result\n}"]}
