{"version":3,"file":"MsiTarget.js","sourceRoot":"","sources":["../../src/targets/MsiTarget.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;AACA,AAAO,AAAE,AAAI,AAAE,AAAG,AAAE,AAAU,AAAE,AAAM,AAAc;;;;;;AACpD,AAAO,AAAE,AAAI,AAAE,AAAM,AAAsB;;;;;;AAC3C,AAAO,AAAE,AAAgB,AAAE,AAAM,AAA8B;;;;;;AAC/D,AAAO,AAAE,AAAI,AAAE,AAAM,AAAqB;;;;;;AAC1C,AAAO,AAAK,AAAG,AAAM,AAAK;;;;;;AAC1B,AAAO,AAAE,AAAQ,AAAE,AAAS,AAAE,AAAM,AAAY;;;;;;AAChD,AAAO,AAAE,AAAI,AAAE,AAAM,AAAU;;;;AAC/B,AAAO,AAAK,AAAI,AAAM,AAAM;;;;AAE5B,AAAO,AAAE,AAAM,AAAE,AAAM,AAAS;;;;;;AAChC,AAAO,AAAsC,AAAmB,AAAE,AAAM,AAAgD;;;;;;AACxH,AAAO,AAAE,AAAe,AAAE,AAAM,AAAqB;;;;;;AACrD,AAAO,AAAE,AAAS,AAAE,AAAM,AAAU;;;;;;AACpC,AAAO,AAAE,AAAa,AAAE,AAAM,AAAc;;;;;;AAE5C,AAAO,AAAE,AAAc,AAAE,AAAM,AAAc;;;;;;;;AAE7C,MAAM,AAAqC,wCAAG,AAAI,yDAAC,AAAK,MAAC,AAAsC,AAAC;AAChG,MAAM,AAAW,cAAG,AAAmB;AAEvC,MAAM,AAAqB,wBAAG,AAAoB;AAElD,MAAM,AAAe,8GAAmC,AAAK,AAAI,AAAE;AACjE,UAAM,AAAQ,WAAG,CAAC,MAAM,AAAQ,8CAAC,AAAI,MAAC,AAAI,KAAC,AAAe,2DAAC,AAAK,AAAC,QAAE,AAAc,AAAC,iBAAE,AAAM,AAAC,AAAC,SACzF,AAAO,QAAC,AAAK,OAAE,AAAI,AAAC,MACpB,AAAO,QAAC,AAAK,OAAE,AAAI,AAAC,MACpB,AAAO,QAAC,AAAc,gBAAE,AAAS,AAAC;AACrC,AAAM,WAAC,AAAG,sBAAC,AAAO,QAAC,AAAQ,AAAC,AAC9B;AAAC,AAAC,CANsB,AAAI,AAAI;AAQhC,AAAmH,AACnH,AAAM,AAAC,AAAO;MAAiB,AAAQ,AAAM;AAK3C,gBAA6B,AAAqB,UAAW,AAAc;AACzE,AAAK,cAAC,AAAK,AAAC;AADe,aAAQ,WAAR,AAAQ,AAAa;AAAW,aAAM,SAAN,AAAM,AAAQ;AAJ1D,aAAE,KAAG,AAAO,QAAC,AAAQ,aAAK,AAAO,AAAC,AAAC,UAAC,AAAI,AAAS,AAAE,AAAC,AAAC,sCAAC,AAAI,AAAa,AAAE;AAEjF,aAAO,UAAe,AAAU,sDAAC,AAAI,KAAC,AAAQ,SAAC,AAA4B,8BAAE,AAAI,KAAC,AAAQ,SAAC,AAAM,OAAC,AAAG,AAAC,AAI/G;AAAC;AAEK,AAAK,SAAX,AAAK,CAAO,AAAiB,WAAE,AAAU;;;;AACvC,kBAAM,AAAQ,WAAG,AAAI,MAAC,AAAQ;AAC9B,kBAAM,AAAY,eAAG,AAAQ,SAAC,AAAyB,0BAAC,AAAI,MAAC,AAAO,SAAE,AAAK,OAAE,AAAI,AAAC;AAClF,kBAAM,AAAY,eAAG,AAAI,MAAC,AAAI,KAAC,AAAI,MAAC,AAAM,QAAE,AAAY,AAAC;AACzD,AAAI,kBAAC,AAAW,YAAC,AAAK,OAAE,AAAY,cAAE,AAAI,AAAC;AAE3C,kBAAM,AAAQ,WAAG,MAAM,AAAc,AAAC,AAAI,+DAAE,AAAQ,UAAE,AAAI,AAAC;AAC3D,kBAAM,AAAE,KAAG,AAAI,MAAC,AAAE;AAElB,kBAAM,AAAa,gBAAG,AAAmB,+GAAC,AAAI,MAAC,AAAO,SAAE,AAAI,MAAC,AAAQ,AAAC;AAEtE,AAAE,AAAC,gBAAC,AAAa,cAAC,AAAU,AAAC,YAAC,AAAC;AAC7B,AAAkH;AAClH,AAAsG;AACtG,AAAG,0DAAC,AAAI,AAAC,KAAkE,AAAC,AAC9E;AAAC;AAED,kBAAM,AAAW,cAAG,AAAQ,SAAC,AAAW,YAAC,AAAa,AAAC;AACvD,kBAAM,AAAW,cAAG,CAAC,AAAgB,AAAC;AACtC,kBAAM,AAAM,SAAG,AAAa,cAAC,AAAU,AAAC,AAAC,aAAE,AAAQ,SAAC,AAAW,YAAC,AAAqB,AAAC,AAAC,AAAC,yBAAC,AAAI;AAC7F,kBAAM,AAAS,+CAAC,AAAW,cAAE,MAAM,AAAI,MAAC,AAAa,cAAC,AAAS,WAAE,AAAI,MAAE,AAAa,AAAC,AAAC;AACtF,AAAE,AAAC,gBAAC,AAAM,WAAK,AAAI,AAAC,MAAC,AAAC;AACpB,sBAAM,AAAS,+CAAC,AAAM,SAAE,MAAM,AAAQ,8CAAC,AAAI,MAAC,AAAI,KAAC,AAAe,2DAAC,AAAK,AAAC,QAAE,AAAqB,AAAC,wBAAE,AAAM,AAAC,AAAC;AACzG,AAAW,4BAAC,AAAI,KAAC,AAAqB,sBAAC,AAAO,QAAC,AAAM,QAAE,AAAS,AAAC,AAAC,AACpE;AAAC;AAED,AAAuC;AACvC,kBAAM,AAAU,aAAG,MAAM,AAAgB,4DAAC,AAAK,OAAE,AAAc,gBAAE,AAA0F,AAAC;AAE5J,AAAuC;AACvC,kBAAM,AAAU,aAAG,CACjB,AAAO,SAAE,AAAI,SAAK,AAAI,2CAAC,AAAI,AAAC,AAAC,OAAC,AAAK,AAAC,AAAC,AAAC,QAAC,AAAI,SAAK,AAAI,2CAAC,AAAM,AAAC,AAAC,SAAC,AAAK,AAAC,AAAC,QAAC,AAAK,AAAC,AAC5E,mBAAY,AAAE,GAAC,AAAQ,SAAC,AAAS,AAAC,UAAE,AACrC,IAAC,AAAM,OAAC,AAAI,MAAC,AAAgB,AAAE,AAAC;AACjC,AAAU,uBAAC,AAAI,KAAC,AAAa,AAAC;AAC9B,AAAE,AAAC,gBAAC,AAAM,WAAK,AAAI,AAAC,MAAC,AAAC;AACpB,AAAU,2BAAC,AAAI,KAAC,AAAqB,AAAC,AACxC;AAAC;AACD,qBAAS,AAAI,KAAC,AAAE,GAAC,AAAQ,SAAC,AAAI,MAAC,AAAI,KAAC,AAAU,YAAE,AAAY,AAAC,AAAC,gBAAE,AAAU;AACxE,AAAG,qBAAE,AAAQ,SAAC,AAAG,AAClB,AAAC;AAF0E,aAAtE,AAAE;AAIR,kBAAM,AAAI,MAAC,AAAK,MAAC,AAAW,aAAE,AAAE,IAAE,AAAY,cAAE,AAAS,WAAE,AAAU,YAAE,AAAQ,SAAC,AAAG,AAAC;AAEpF,kBAAM,AAAQ,SAAC,AAAO,AAAE;AAExB,kBAAM,AAAQ,SAAC,AAAI,KAAC,AAAY,AAAC;AAEjC,AAAQ,qBAAC,AAAI,KAAC,AAAuB;AACnC,AAAI,sBAAE,AAAY;AAClB,AAAQ;AACR,AAAI;AACJ,AAAgB,kCAAE,AAAQ,SAAC,AAAuB,wBAAC,AAAY,cAAE,AAAK,AAAC;AACvE,AAAM,AAAE,AAAI;AACZ,AAAiB,mCAAE,AAAK,AACzB,AAAC,AACJ;AARwC;;AAQvC;AAEa,AAAK,SAAX,AAAK,CAAO,AAA0B,aAAE,AAAa,IAAE,AAAoB,cAAE,AAAiB,WAAE,AAAkB,YAAE,AAAe;;;;AACzI,AAAuC;AACvC,kBAAM,AAAS,aACb,AAAM,QAAE,AAAE,GAAC,AAAQ,SAAC,AAAY,AAAC,eACjC,AAAI;AACJ,AAAmD;AACnD,AAAO,mBAJS;AAKhB,AAA2C;AAC3C,AAAkK;AAClK,AAAS,AACT,mCAAY,AAAE,GAAC,AAAQ,SAAC,AAAS,AAAC,UAAE,AAErC,IAAC,AAAM,OAAC,AAAI,OAAC,AAAgB,AAAE,AAAC;AAEjC,AAAqL;AACrL,AAAE,AAAC,gBAAC,AAAO,QAAC,AAAQ,aAAK,AAAO,AAAC,SAAC,AAAC;AACjC,AAAuC;AACvC,AAAS,0BAAC,AAAI,KAAC,AAAO,AAAC,AACzB;AAAC;AAED,AAAE,AAAC,gBAAC,AAAI,OAAC,AAAO,QAAC,AAAQ,aAAK,AAAK,AAAC,OAAC,AAAC;AACpC,AAAS,0BAAC,AAAI,KAAC,AAAM,QAAE,AAAgB,AAAC,AAC1C;AAAC;AAED,AAA+E;AAC/E,AAAS,sBAAC,AAAI,KAAC,GAAG,AAAW,AAAC;AAC9B,qBAAS,AAAI,KAAC,AAAE,GAAC,AAAQ,SAAC,AAAI,MAAC,AAAI,KAAC,AAAU,YAAE,AAAW,AAAC,AAAC,eAAE,AAAS;AACtE,AAAG,qBAAE,AAAO,AACb,AAAC,AACJ;AAH4E,aAApE,AAAE;;AAGT;AAEO,AAAgB;AACtB,cAAM,AAAI,OAAkB,CAAC,AAAW,AAAC;AACzC,AAAE,AAAC,YAAC,AAAI,KAAC,AAAO,QAAC,AAAgB,qBAAK,AAAK,AAAC,OAAC,AAAC;AAC5C,AAAI,iBAAC,AAAI,KAAC,AAAK,AAAC,AAClB;AAAC;AACD,AAAM,eAAC,AAAI,AACb;AAAC;AAEa,AAAa,iBAAnB,AAAK,CAAe,AAAiB,WAAE,AAAU,MAAE,AAAiD;;;;AAC1G,kBAAM,AAAO,UAAG,AAAI,OAAC,AAAQ,SAAC,AAAO;AACrC,kBAAM,EAAC,AAAK,OAAE,AAAI,AAAC,SAAG,MAAM,AAAI,OAAC,AAAsB,uBAAC,AAAS,AAAC;AAElE,kBAAM,AAAW,cAAG,AAAO,QAAC,AAAW;AACvC,AAAE,AAAC,gBAAC,CAAC,AAAW,AAAC,aAAC,AAAC;AACjB,AAAG,0DAAC,AAAI,AAAC,KAA2E,AAAC,AACvF;AAAC;AAED,kBAAM,AAAW,cAAG,AAAI,OAAC,AAAQ,SAAC,AAAW;AAC7C,kBAAM,AAAO,UAAG,AAAI,OAAC,AAAO;AAC5B,kBAAM,AAAQ,WAAG,MAAM,AAAI,OAAC,AAAQ,SAAC,AAAW,AAAE;AAClD,AAAM,mBAAC,CAAC,MAAM,AAAe,gBAAC,AAAK,AAAC,yBAC/B,AAAa,iBAChB,AAAgB,kBAAE,AAAO,QAAC,AAAc,mBAAK,AAAK,OAClD,AAAQ,UAAE,AAAQ,YAAI,AAAI,AAAC,AAAC,OAAC,AAAI,AAAC,AAAC,OAAC,AAAI,OAAC,AAAE,GAAC,AAAQ,SAAC,AAAQ,AAAC,WAC9D,AAAgB,kBAAE,AAAW,gBAAK,AAAO,AAAC,AAAC,UAAC,AAAM,AAAC,AAAC,SAAC,AAAM,QAC3D,AAAO,SAAE,AAAO,QAAC,AAAyB,2BAC1C,AAAW,aAAE,AAAO,QAAC,AAAW,aAChC,AAAW,aAAE,CAAC,AAAO,QAAC,AAAW,eAAI,AAAI,yDAAC,AAAE,GAAC,AAAO,QAAC,AAAE,IAAE,AAAqC,AAAC,AAAC,wCAAC,AAAW,AAAE,eAC9G,AAAY,cAAE,AAAW,eAAI,AAAO,QAAC,AAAW,aAChD,AAAc,gBAAE,AAAO,QAAC,AAAW;AACnC,AAA6G;AAC7G,AAAc,gCAAE,AAAI,SAAK,AAAI,2CAAC,AAAG,AAAC,AAAC,MAAC,AAAsB,AAAC,AAAC,yBAAC,AAAoB;AACjF,AAAqE;AACrE,AAA4B,8CAAE,AAAoB,qBAAC,AAAI,KAAC,AAAO,QAAC,AAAe,AAAC,AAAC,AAAC,mBAAC,AAAO,QAAC,AAAe,AAAC,AAAC,kBAAC,AAAO,QAAC,AAAa,eAClI,AAAI;AACJ,AAAK,AACL,AACJ;;AAAC;AAEa,AAAsB,0BAA5B,AAAK,CAAwB,AAAiB;;;;AACpD,kBAAM,AAAO,UAAG,AAAI,OAAC,AAAQ,SAAC,AAAO;AACrC,gBAAI,AAA2B,8BAAG,AAAK;AACvC,kBAAM,AAAQ,WAAG,IAAI,AAAG,AAAU;AAClC,kBAAM,AAAI,OAAkB,AAAE;AAC9B,kBAAM,AAAS,YAAG,AAAG,IAAC,AAAM,OAAC,AAAC,AAAC;AAC/B,kBAAM,AAAa,gBAAG,AAAmB,+GAAC,AAAI,OAAC,AAAO,SAAE,AAAI,OAAC,AAAQ,AAAC;AACtE,kBAAM,AAAK,QAAG,sDAAsB,AAAG,IAAC,AAAI,8BAAC,AAAS,AAAC,YAAE,AAAI,AAAC,AAAE;AAC9D,sBAAM,AAAW,cAAG,AAAI,KAAC,AAAS,UAAC,AAAS,UAAC,AAAM,SAAG,AAAC,AAAC;AAExD,sBAAM,AAAS,YAAG,AAAW,YAAC,AAAW,YAAC,AAAI,MAAC,AAAG,AAAC;AACnD,sBAAM,AAAQ,WAAG,AAAS,YAAG,AAAC,AAAC,AAAC,IAAC,AAAW,YAAC,AAAS,UAAC,AAAS,YAAG,AAAC,AAAC,AAAC,AAAC,KAAC,AAAW;AACnF,oBAAI,AAAW,cAAkB,AAAI;AACrC,oBAAI,AAAO,UAAG,AAAE;AAChB,AAAgH;AAChH,AAAE,AAAC,oBAAC,AAAS,YAAG,AAAC,AAAC,GAAC,AAAC;AAClB,AAA8F;AAC9F,AAA+O;AAC/O,AAA2F;AAC3F,AAAO,8BAAG,AAAW,YAAC,AAAS,UAAC,AAAC,GAAE,AAAS,AAAC;AAC7C,AAA2F;AAC3F,AAAW,AAAG,qCAAG,AAAO,QAAC,AAAW,AAAE,aAAI;AAC1C,AAAE,AAAC,wBAAC,CAAC,AAAQ,SAAC,AAAG,IAAC,AAAO,AAAC,AAAC,UAAC,AAAC;AAC3B,AAAQ,iCAAC,AAAG,IAAC,AAAO,AAAC;AACrB,AAAI,6BAAC,AAAI,AAAC,uBAAkB,AAAW,sBAAW,AAAW,iBAAM,AAAO,OAAO,AAAC,AACpF;AAAC,AACH;AAAC,AACD,AAAI,uBAAC,AAAE,AAAC,IAAC,CAAC,AAA2B,AAAC,6BAAC,AAAC;AACtC,AAA2B,kDAAG,AAAI,AACpC;AAAC;AAED,AAAkH;AAClH,AAA8E;AAC9E,oBAAI,AAAM,AAAG,sBAAa,AAAW,gBAAK,AAAI,AAAC,AAAC,OAAC,AAAE,AAAC,AAAC,AAAC,oBAAe,AAAW,WAAG,GAAG;AACtF,AAAM,AAAI,+BAAK,AAAS,0BAAiB,AAAQ,kCAA0B,AAAI,MAAC,AAAG,MAAG,AAAW,WAAgC;AACjI,sBAAM,AAAgB,mBAAG,AAAW,AAAK,mBAAG,AAAO,QAAC,AAAe,eAAM;AACzE,AAAE,AAAC,oBAAC,AAAgB,AAAC,kBAAC,AAAC;AACrB,AAAM,8BAAI,AAAsB,AAClC;AAAC,AACD,AAAI,uBAAC,AAAE,AAAC,IAAC,AAAW,gBAAK,AAAI,AAAC,MAAC,AAAC;AAC9B,AAAM,AAAI,sCAAQ,AAAI,MAAC,AAAQ,SAAC,AAAW,AAAC,YAAK,AACnD;AAAC;AACD,AAAE,AAAC,oBAAC,AAAgB,AAAI,qBAAC,AAAa,cAAC,AAAuB,2BAAI,AAAa,cAAC,AAAyB,AAAC,AAAC,4BAAC,AAAC;AAC3G,AAAM,AAAI,8BAAK;AACf,0BAAM,AAAY,eAAG,AAAa,cAAC,AAAY;AAC/C,AAAE,AAAC,wBAAC,AAAa,cAAC,AAAuB,AAAC,yBAAC,AAAC;AAC1C,AAAM,AAAI,qCAAG,AAAS,6EAAoE,AAAY,YAA4E,AACpL;AAAC;AAED,0BAAM,AAAe,kBAAG,AAAa,cAAC,AAAY,gBAAI,AAAI;AAC1D,0BAAM,AAA4B,+BAAG,AAAe,AAAC,AAAC,kBAAC,AAAmB,AAAC,AAAC,sBAAC,AAAmB;AAChG,AAAE,AAAC,wBAAC,AAAa,cAAC,AAAyB,AAAC,2BAAC,AAAC;AAC5C,AAAE,AAAC,4BAAC,AAAe,AAAC,iBAAC,AAAC;AACpB,AAAI,iCAAC,AAAI,AAAC,uBAAkB,AAA4B,2DAA+B,AAAa,cAAC,AAAY,YAAO,AAAC,AAC3H;AAAC;AACD,AAAM,AAAI,qCAAG,AAAS,0DAAiD,AAA4B,uCAAW,AAAY,YAA4E,AACxM;AAAC;AACD,AAAM,AAAI,iCAAG,AAAS,SAAS;AAE/B,AAAE,AAAC,wBAAC,AAAe,AAAC,iBAAC,AAAC;AACpB,AAAM,AAAI,uDAAqB,AAA4B,4BAAsB,AACnF;AAAC,AACH;AAAC,AACD,AAAI,uBAAC,AAAC;AACJ,AAAM,AAAI,8BAAI,AAChB;AAAC;AAED,AAAM,AAAC,0BAAG,AAAM,WAAK,AAAS,SAAc,AAC9C;AAAC,AAAC,aA7DkB,AAAe;AA+DnC,AAAM,mBAAC,EAAC,AAAI,MAAE,AAAY,aAAC,AAAI,MAAE,AAAC,AAAC,IAAE,AAAK,OAAE,AAAY,aAAC,AAAK,OAAE,AAAC,AAAC,AAAC,AACrE;;AAAC,AACF;;;AAED,sBAAsB,AAAmB,MAAE,AAAoB;AAC7D,UAAM,AAAK,QAAG,AAAG,IAAC,AAAM,OAAC,AAAW,cAAG,AAAC,AAAC;AACzC,AAAM,WAAC,AAAI,KAAC,AAAI,AAAC,UAAK,AAAK,KAAE,AAAC,AAChC;AAAC","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { Arch, log, deepAssign } from \"builder-util\"\nimport { UUID } from \"builder-util-runtime\"\nimport { getBinFromGithub } from \"builder-util/out/binDownload\"\nimport { walk } from \"builder-util/out/fs\"\nimport * as ejs from \"ejs\"\nimport { readFile, writeFile } from \"fs-extra-p\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport { MsiOptions } from \"../\"\nimport { Target } from \"../core\"\nimport { FinalCommonWindowsInstallerOptions, getEffectiveOptions } from \"../options/CommonWindowsInstallerConfiguration\"\nimport { getTemplatePath } from \"../util/pathManager\"\nimport { VmManager } from \"../vm/vm\"\nimport { WineVmManager } from \"../vm/WineVm\"\nimport { WinPackager } from \"../winPackager\"\nimport { createStageDir } from \"./targetUtil\"\n\nconst ELECTRON_BUILDER_UPGRADE_CODE_NS_UUID = UUID.parse(\"d752fe43-5d44-44d5-9fc9-6dd1bf19d5cc\")\nconst ROOT_DIR_ID = \"APPLICATIONFOLDER\"\n\nconst ASSISTED_UI_FILE_NAME = \"WixUI_Assisted.wxs\"\n\nconst projectTemplate = new Lazy<(data: any) => string>(async () => {\n  const template = (await readFile(path.join(getTemplatePath(\"msi\"), \"template.xml\"), \"utf8\"))\n    .replace(/{{/g, \"<%\")\n    .replace(/}}/g, \"%>\")\n    .replace(/\\${([^}]+)}/g, \"<%=$1%>\")\n  return ejs.compile(template)\n})\n\n// WiX doesn't support Mono, so, dontnet462 is required to be installed for wine (preinstalled in our bundled wine)\nexport default class MsiTarget extends Target {\n  private readonly vm = process.platform === \"win32\" ? new VmManager() : new WineVmManager()\n\n  readonly options: MsiOptions = deepAssign(this.packager.platformSpecificBuildOptions, this.packager.config.msi)\n\n  constructor(private readonly packager: WinPackager, readonly outDir: string) {\n    super(\"msi\")\n  }\n\n  async build(appOutDir: string, arch: Arch) {\n    const packager = this.packager\n    const artifactName = packager.expandArtifactNamePattern(this.options, \"msi\", arch)\n    const artifactPath = path.join(this.outDir, artifactName)\n    this.logBuilding(\"MSI\", artifactPath, arch)\n\n    const stageDir = await createStageDir(this, packager, arch)\n    const vm = this.vm\n\n    const commonOptions = getEffectiveOptions(this.options, this.packager)\n\n    if (commonOptions.isAssisted) {\n      // F*** *** ***  ***  ***  ***  ***  ***  ***  ***  ***  ***  *** WiX  ***  ***  ***  ***  ***  ***  ***  ***  ***\n      // cannot understand how to set MSIINSTALLPERUSER on radio box change. In any case installed per user.\n      log.warn(`MSI DOESN'T SUPPORT assisted installer. Please use NSIS instead.`)\n    }\n\n    const projectFile = stageDir.getTempFile(\"project.wxs\")\n    const objectFiles = [\"project.wixobj\"]\n    const uiFile = commonOptions.isAssisted ?  stageDir.getTempFile(ASSISTED_UI_FILE_NAME) : null\n    await writeFile(projectFile, await this.writeManifest(appOutDir, arch, commonOptions))\n    if (uiFile !== null) {\n      await writeFile(uiFile, await readFile(path.join(getTemplatePath(\"msi\"), ASSISTED_UI_FILE_NAME), \"utf8\"))\n      objectFiles.push(ASSISTED_UI_FILE_NAME.replace(\".wxs\", \".wixobj\"))\n    }\n\n    // noinspection SpellCheckingInspection\n    const vendorPath = await getBinFromGithub(\"wix\", \"4.0.0.5512.2\", \"/X5poahdCc3199Vt6AP7gluTlT1nxi9cbbHhZhCMEu+ngyP1LiBMn+oZX7QAZVaKeBMc2SjVp7fJqNLqsUnPNQ==\")\n\n    // noinspection SpellCheckingInspection\n    const candleArgs = [\n      \"-arch\", arch === Arch.ia32 ? \"x86\" : (arch === Arch.armv7l ? \"arm\" : \"x64\"),\n      `-dappDir=${vm.toVmFile(appOutDir)}`,\n    ].concat(this.getCommonWixArgs())\n    candleArgs.push(\"project.wxs\")\n    if (uiFile !== null) {\n      candleArgs.push(ASSISTED_UI_FILE_NAME)\n    }\n    await vm.exec(vm.toVmFile(path.join(vendorPath, \"candle.exe\")), candleArgs, {\n      cwd: stageDir.dir,\n    })\n\n    await this.light(objectFiles, vm, artifactPath, appOutDir, vendorPath, stageDir.dir)\n\n    await stageDir.cleanup()\n\n    await packager.sign(artifactPath)\n\n    packager.info.dispatchArtifactCreated({\n      file: artifactPath,\n      packager,\n      arch,\n      safeArtifactName: packager.computeSafeArtifactName(artifactName, \"msi\"),\n      target: this,\n      isWriteUpdateInfo: false,\n    })\n  }\n\n  private async light(objectFiles: Array<string>, vm: VmManager, artifactPath: string, appOutDir: string, vendorPath: string, tempDir: string) {\n    // noinspection SpellCheckingInspection\n    const lightArgs = [\n      \"-out\", vm.toVmFile(artifactPath),\n      \"-v\",\n      // https://github.com/wixtoolset/issues/issues/5169\n      \"-spdb\",\n      // https://sourceforge.net/p/wix/bugs/2405/\n      // error LGHT1076 : ICE61: This product should remove only older versions of itself. The Maximum version is not less than the current product. (1.1.0.42 1.1.0.42)\n      \"-sw1076\",\n      `-dappDir=${vm.toVmFile(appOutDir)}`,\n      // \"-dcl:high\",\n    ].concat(this.getCommonWixArgs())\n\n    // http://windows-installer-xml-wix-toolset.687559.n2.nabble.com/Build-3-5-2229-0-give-me-the-following-error-error-LGHT0216-An-unexpected-Win32-exception-with-errorn-td5707443.html\n    if (process.platform !== \"win32\") {\n      // noinspection SpellCheckingInspection\n      lightArgs.push(\"-sval\")\n    }\n\n    if (this.options.oneClick === false) {\n      lightArgs.push(\"-ext\", \"WixUIExtension\")\n    }\n\n    // objectFiles - only filenames, we set current directory to our temp stage dir\n    lightArgs.push(...objectFiles)\n    await vm.exec(vm.toVmFile(path.join(vendorPath, \"light.exe\")), lightArgs, {\n      cwd: tempDir,\n    })\n  }\n\n  private getCommonWixArgs() {\n    const args: Array<string> = [\"-pedantic\"]\n    if (this.options.warningsAsErrors !== false) {\n      args.push(\"-wx\")\n    }\n    return args\n  }\n\n  private async writeManifest(appOutDir: string, arch: Arch, commonOptions: FinalCommonWindowsInstallerOptions) {\n    const appInfo = this.packager.appInfo\n    const {files, dirs} = await this.computeFileDeclaration(appOutDir)\n\n    const companyName = appInfo.companyName\n    if (!companyName) {\n      log.warn(`Manufacturer is not set for MSI — please set \"author\" in the package.json`)\n    }\n\n    const compression = this.packager.compression\n    const options = this.options\n    const iconPath = await this.packager.getIconPath()\n    return (await projectTemplate.value)({\n      ...commonOptions,\n      isRunAfterFinish: options.runAfterFinish !== false,\n      iconPath: iconPath == null ? null : this.vm.toVmFile(iconPath),\n      compressionLevel: compression === \"store\" ? \"none\" : \"high\",\n      version: appInfo.versionInWeirdWindowsForm,\n      productName: appInfo.productName,\n      upgradeCode: (options.upgradeCode || UUID.v5(appInfo.id, ELECTRON_BUILDER_UPGRADE_CODE_NS_UUID)).toUpperCase(),\n      manufacturer: companyName || appInfo.productName,\n      appDescription: appInfo.description,\n      // https://stackoverflow.com/questions/1929038/compilation-error-ice80-the-64bitcomponent-uses-32bitdirectory\n      programFilesId: arch === Arch.x64 ? \"ProgramFiles64Folder\" : \"ProgramFilesFolder\",\n      // wix in the name because special wix format can be used in the name\n      installationDirectoryWixName: /^[-_+0-9a-zA-Z ]+$/.test(appInfo.productFilename) ? appInfo.productFilename : appInfo.sanitizedName,\n      dirs,\n      files,\n    })\n  }\n\n  private async computeFileDeclaration(appOutDir: string) {\n    const appInfo = this.packager.appInfo\n    let isRootDirAddedToRemoveTable = false\n    const dirNames = new Set<string>()\n    const dirs: Array<string> = []\n    const fileSpace = \" \".repeat(6)\n    const commonOptions = getEffectiveOptions(this.options, this.packager)\n    const files = await BluebirdPromise.map(walk(appOutDir), file => {\n      const packagePath = file.substring(appOutDir.length + 1)\n\n      const lastSlash = packagePath.lastIndexOf(path.sep)\n      const fileName = lastSlash > 0 ? packagePath.substring(lastSlash + 1) : packagePath\n      let directoryId: string | null = null\n      let dirName = \"\"\n      // Wix Directory.FileSource doesn't work - https://stackoverflow.com/questions/21519388/wix-filesource-confusion\n      if (lastSlash > 0) {\n        // This Name attribute may also define multiple directories using the inline directory syntax.\n        // For example, \"ProgramFilesFolder:\\My Company\\My Product\\bin\" would create a reference to a Directory element with Id=\"ProgramFilesFolder\" then create directories named \"My Company\" then \"My Product\" then \"bin\" nested beneath each other.\n        // This syntax is a shortcut to defining each directory in an individual Directory element.\n        dirName = packagePath.substring(0, lastSlash)\n        // add U (user) suffix just to be sure that will be not overwrite system WIX directory ids.\n        directoryId = `${dirName.toLowerCase()}_u`\n        if (!dirNames.has(dirName)) {\n          dirNames.add(dirName)\n          dirs.push(`<Directory Id=\"${directoryId}\" Name=\"${ROOT_DIR_ID}:\\\\${dirName}\\\\\"/>`)\n        }\n      }\n      else if (!isRootDirAddedToRemoveTable) {\n        isRootDirAddedToRemoveTable = true\n      }\n\n      // since RegistryValue can be part of Component, *** *** *** *** *** *** *** *** *** wix cannot auto generate guid\n      // https://stackoverflow.com/questions/1405100/change-my-component-guid-in-wix\n      let result = `<Component${directoryId === null ? \"\" : ` Directory=\"${directoryId}\"`}>`\n      result += `\\n${fileSpace}  <File Name=\"${fileName}\" Source=\"$(var.appDir)${path.sep}${packagePath}\" ReadOnly=\"yes\" KeyPath=\"yes\"`\n      const isMainExecutable = packagePath === `${appInfo.productFilename}.exe`\n      if (isMainExecutable) {\n        result += ' Id=\"mainExecutable\"'\n      }\n      else if (directoryId === null) {\n        result += ` Id=\"${path.basename(packagePath)}_f\"`\n      }\n      if (isMainExecutable && (commonOptions.isCreateDesktopShortcut || commonOptions.isCreateStartMenuShortcut)) {\n        result += `>\\n`\n        const shortcutName = commonOptions.shortcutName\n        if (commonOptions.isCreateDesktopShortcut) {\n          result += `${fileSpace}  <Shortcut Id=\"desktopShortcut\" Directory=\"DesktopFolder\" Name=\"${shortcutName}\" WorkingDirectory=\"APPLICATIONFOLDER\" Advertise=\"yes\" Icon=\"icon.ico\"/>\\n`\n        }\n\n        const hasMenuCategory = commonOptions.menuCategory != null\n        const startMenuShortcutDirectoryId = hasMenuCategory ? \"AppProgramMenuDir\" : \"ProgramMenuFolder\"\n        if (commonOptions.isCreateStartMenuShortcut) {\n          if (hasMenuCategory) {\n            dirs.push(`<Directory Id=\"${startMenuShortcutDirectoryId}\" Name=\"ProgramMenuFolder:\\\\${commonOptions.menuCategory}\\\\\"/>`)\n          }\n          result += `${fileSpace}  <Shortcut Id=\"startMenuShortcut\" Directory=\"${startMenuShortcutDirectoryId}\" Name=\"${shortcutName}\" WorkingDirectory=\"APPLICATIONFOLDER\" Advertise=\"yes\" Icon=\"icon.ico\"/>\\n`\n        }\n        result += `${fileSpace}</File>`\n\n        if (hasMenuCategory) {\n          result += `<RemoveFolder Id=\"${startMenuShortcutDirectoryId}\" On=\"uninstall\"/>\\n`\n        }\n      }\n      else {\n        result += `/>`\n      }\n\n      return `${result}\\n${fileSpace}</Component>`\n    })\n\n    return {dirs: listToString(dirs, 2), files: listToString(files, 3)}\n  }\n}\n\nfunction listToString(list: Array<string>, indentLevel:  number) {\n  const space = \" \".repeat(indentLevel * 2)\n  return list.join(`\\n${space}`)\n}"]}
