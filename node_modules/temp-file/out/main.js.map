{"version":3,"file":"main.js","sourceRoot":"","sources":["../src/main.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { ensureDir, mkdtemp, realpath, remove, removeSync, unlink, unlinkSync } from \"fs-extra-p\"\nimport { Lazy } from \"lazy-val\"\nimport { tmpdir } from \"os\"\nimport * as path from \"path\"\n\nlet tmpFileCounter = 0\nconst tmpDirManagers = new Set<TmpDir>()\n\n// add date to avoid use stale temp dir\nconst tempDirPrefix = `${process.pid.toString(36)}-${Date.now().toString(36)}`\n\nexport function getTempName(prefix?: string | null | undefined): string {\n  return `${prefix == null ? \"\" : `${prefix}-`}${tempDirPrefix}-${(tmpFileCounter++).toString(36)}`\n}\n\nconst tempDir = new Lazy<string>(() => {\n  let promise: Promise<string>\n  const systemTmpDir = process.env.TEST_TMP_DIR || process.env.ELECTRON_BUILDER_TMP_DIR || process.env.ELECTRON_BUILDER_TEST_DIR || tmpdir()\n  const isEnsureRemovedOnExit = process.env.TMP_DIR_MANAGER_ENSURE_REMOVED_ON_EXIT !== \"false\"\n  if (!isEnsureRemovedOnExit) {\n    promise = Promise.resolve(systemTmpDir)\n  }\n  else if (mkdtemp == null) {\n    const dir = path.join(systemTmpDir, getTempName(\"temp-files\"))\n    promise = ensureDir(dir, {mode: 448}).then(() => dir)\n  }\n  else {\n    promise = mkdtemp(`${path.join(systemTmpDir, \"temp-dir\")}-`)\n  }\n\n  return promise\n    .then(it => realpath(it))\n    .then(dir => {\n      if (isEnsureRemovedOnExit) {\n        addExitHook(dir)\n      }\n      return dir\n    })\n})\n\nfunction addExitHook(dir: string) {\n  require(\"async-exit-hook\")((callback: (() => void) | null) => {\n    const managers = Array.from(tmpDirManagers)\n    tmpDirManagers.clear()\n\n    if (callback == null) {\n      for (const manager of managers) {\n        manager.cleanupSync()\n      }\n\n      try {\n        removeSync(dir)\n      }\n      catch (e) {\n        handleError(e, dir)\n      }\n      return\n    }\n\n    // each instead of map to avoid fs overload\n    BluebirdPromise.each(managers, it => it.cleanup())\n      .then(() => remove(dir))\n      .then(() => callback())\n      .catch(e => {\n        try {\n          handleError(e, dir)\n        }\n        finally {\n          callback()\n        }\n      })\n  })\n}\n\nfunction handleError(e: any, file: string) {\n  if (e.code !== \"EPERM\" && e.code !== \"ENOENT\") {\n    // use only console.* instead of our warn on exit (otherwise nodeEmoji can be required on request)\n    console.warn(`Cannot delete temporary \"${file}\": ${(e.stack || e).toString()}`)\n  }\n}\n\ninterface TempFileInfo {\n  isDir: boolean\n  path: string\n  disposer?: ((file: string) => Promise<void>) | null\n}\n\nexport interface GetTempFileOptions {\n  prefix?: string | null\n  suffix?: string | null\n\n  disposer?: ((file: string) => Promise<void>) | null\n}\n\nexport class TmpDir {\n  private tempFiles: Array<TempFileInfo> = []\n  private registered = false\n\n  constructor(private readonly debugName: string = \"\") {\n  }\n\n  // noinspection JSMethodCanBeStatic\n  // noinspection JSUnusedGlobalSymbols\n  get rootTempDir(): Promise<string> {\n    return tempDir.value\n  }\n\n  getTempDir(options?: GetTempFileOptions): Promise<string> {\n    return this.getTempFile(options, true)\n  }\n\n  createTempDir(options?: GetTempFileOptions): Promise<string> {\n    return this.getTempFile(options, true)\n      .then(it => ensureDir(it).then(() => it))\n  }\n\n  getTempFile(options?: GetTempFileOptions, isDir = false): Promise<string> {\n    return tempDir.value\n      .then(it => {\n        if (!this.registered) {\n          this.registered = true\n          tmpDirManagers.add(this)\n        }\n\n        const prefix = nullize(options == null ? null : options.prefix)\n        const suffix = nullize(options == null ? null : options.suffix)\n        const namePrefix = prefix == null ? \"\" : `${prefix}-`\n        const nameSuffix = suffix == null ? \"\" : (suffix.startsWith(\".\") ? suffix : `-${suffix}`)\n        const result = `${it}${path.sep}${namePrefix}${(tmpFileCounter++).toString(36)}${nameSuffix}`\n        this.tempFiles.push({\n          path: result,\n          isDir,\n          disposer: options == null ? null : options.disposer,\n        })\n        return result\n      })\n  }\n\n  cleanupSync() {\n    const tempFiles = this.tempFiles\n    tmpDirManagers.delete(this)\n    this.registered = false\n    if (tempFiles.length === 0) {\n      return\n    }\n\n    this.tempFiles = []\n\n    for (const file of tempFiles) {\n      if (file.disposer != null) {\n        // noinspection JSIgnoredPromiseFromCall\n        file.disposer(file.path)\n        continue\n      }\n\n      try {\n        if (file.isDir) {\n          removeSync(file.path)\n        }\n        else {\n          unlinkSync(file.path)\n        }\n      }\n      catch (e) {\n        handleError(e, file.path)\n      }\n    }\n  }\n\n  cleanup(): Promise<any> {\n    const tempFiles = this.tempFiles\n    tmpDirManagers.delete(this)\n    this.registered = false\n    if (tempFiles.length === 0) {\n      return Promise.resolve()\n    }\n\n    this.tempFiles = []\n\n    return BluebirdPromise.map(tempFiles, it => {\n      if (it.disposer != null) {\n        return it.disposer(it.path)\n      }\n\n      return (it.isDir ? remove(it.path) : unlink(it.path))\n        .catch(e => {\n          handleError(e, it.path)\n        })\n    }, {concurrency: 8})\n  }\n\n  toString() {\n    return this.debugName\n  }\n}\n\nfunction nullize(s?: string | null) {\n  return s == null || s.length === 0 ? null : s\n}"]}
